     1                                  [org 0]
     2                                  [bits 64]
     3                                  
     4                                  ;pj!CInjectData::Package
     5                                  ;   +0x000 InitialCode      : [2048] UChar
     6                                  ;   +0x800 DllPath          : [260] Uint2B
     7                                  ;   +0xa08 peb              : Ptr64 Void
     8                                  ;   +0xa10 ntdll            : Ptr64 Void
     9                                  ;   +0xa18 kernel32         : Ptr64 Void
    10                                  ;   +0xa20 LoadLibraryW     : Ptr64 Void
    11                                  ;   +0xa28 FreeLibrary      : Ptr64 Void
    12                                  ;   +0xa30 GetProcAddress   : Ptr64 Void
    13                                  ;   +0xa38 CreateThread     : Ptr64 Void
    14                                  ;   +0xa40 ExitThread       : Ptr64 Void
    15                                  ;   +0xa48 WaitForSingleObject : Ptr64 Void
    16                                  ;   +0xa50 CloseHandle      : Ptr64 Void
    17                                  ;   +0xa58 Context          : [1] UChar
    18                                  
    19                                  ShellCode:
    20 00000000 53                      push rbx
    21 00000001 4883EC30                sub rsp,byte +0x30
    22 00000005 65488B042530000000      mov rax,[gs:0x30]
    23 0000000E 4889CB                  mov rbx,rcx             ; rbx=Context
    24 00000011 488B5060                mov rdx,[rax+0x60]
    25 00000015 488991080A0000          mov [rcx+0xa08],rdx     ; rcx=Context, rdx=peb
    26 0000001C E8A6000000              call GetImageBase
    27                                  
    28 00000021 488B8B100A0000          mov rcx,[rbx+0xa10]     ; rcx=ntdll
    29 00000028 4889DA                  mov rdx,rbx             ; rdx=Context
    30 0000002B E885010000              call GetProcAddress
    31                                  
    32 00000030 488B8B180A0000          mov rcx,[rbx+0xa18]     ; rcx=kernel32
    33 00000037 4889DA                  mov rdx,rbx             ; rdx=Context
    34 0000003A E876010000              call GetProcAddress
    35                                  
    36 0000003F 4889D9                  mov     rcx, rbx
    37 00000042 4881C100080000          add     rcx, 800h
    38 00000049 FF93200A0000            call    [rbx+0A20h]       ; LoadLibrary
    39 0000004F 4889C7                  mov     rdi, rax
    40 00000052 4885C0                  test    rax, rax
    41 00000055 745C                    je      label352e15fe
    42                                  
    43 00000057 BAADDE0000              mov     edx, 0DEADh                  ; Ordinal
    44 0000005C 4889C1                  mov     rcx, rax
    45 0000005F FF93300A0000            call    [rbx+0A30h]       ; GetProcAddress
    46 00000065 4885C0                  test    rax, rax
    47 00000068 7440                    je      label352e15f5
    48                                  
    49 0000006A 31C9                    xor     ecx, ecx
    50 0000006C 4989D9                  mov     r9, rbx
    51 0000006F 4989C0                  mov     r8, rax
    52 00000072 48894C2428              mov     [rsp+28h], rcx
    53 00000077 31D2                    xor     edx,edx
    54 00000079 4889742440              mov     [rsp+40h], rsi
    55 0000007E 894C2420                mov     [rsp+20h], ecx
    56 00000082 FF93380A0000            call    [rbx+0A38h]       ; CreateThread
    57 00000088 4889C6                  mov     rsi, rax
    58 0000008B 4885C0                  test    rax, rax
    59 0000008E 7415                    je      label352e15f0
    60                                  
    61 00000090 83CAFF                  or      edx, 0FFFFFFFFh
    62 00000093 4889C1                  mov     rcx, rax
    63 00000096 FF93480A0000            call    [rbx+0A48h]       ; WaitForSingleObject
    64 0000009C 4889F1                  mov     rcx, rsi
    65 0000009F FF93500A0000            call    [rbx+0A50h]       ; CloseHandle
    66                                  
    67                                  label352e15f0:
    68 000000A5 488B742440              mov     rsi, [rsp+40h]
    69                                  
    70                                  label352e15f5:
    71 000000AA 4889F9                  mov     rcx, rdi
    72 000000AD FF93280A0000            call    [rbx+0A28h]       ; FreeLibrary
    73                                  
    74                                  label352e15fe:
    75 000000B3 31C9                    xor     ecx, ecx
    76 000000B5 FF93400A0000            call    [rbx+0A40h]       ; ExitThread
    77                                  
    78 000000BB B82A000000              mov eax,0x2a
    79 000000C0 4883C430                add rsp,byte +0x30
    80 000000C4 5B                      pop rbx
    81 000000C5 C3                      ret
    82                                  
    83 000000C6 CC                      int3
    84                                  
    85                                  GetImageBase:
    86 000000C7 488B81080A0000          mov rax,[rcx+0xa08]     ; rax = PEB
    87 000000CE 4989C8                  mov r8,rcx
    88 000000D1 4C8B4818                mov r9,[rax+0x18]       ; PEB::Ldr
    89 000000D5 498B5120                mov rdx,[r9+0x20]       ; PEB::Ldr->InMemoryOrderModuleList
    90 000000D9 4983C120                add r9,byte +0x20
    91 000000DD 4C39CA                  cmp rdx,r9
    92 000000E0 0F84CC000000            jz label0xeb
    93                                  
    94 000000E6 4C8B91100A0000          mov r10,[rcx+0xa10]
    95                                  
    96                                  label0x26:
    97 000000ED 488B4250                mov rax,[rdx+0x50]
    98 000000F1 4D85D2                  test r10,r10
    99 000000F4 751A                    jnz label0x49
   100                                  
   101 000000F6 81386E007400            cmp dword [rax],0x74006e
   102 000000FC 7512                    jnz label0x49
   103                                  
   104 000000FE 81780464006C00          cmp dword [rax+0x4],0x6c0064
   105 00000105 7509                    jnz label0x49
   106                                  
   107 00000107 8178086C002E00          cmp dword [rax+0x8],0x2e006c
   108 0000010E 741C                    jz label0x65
   109                                  
   110                                  label0x49:
   111 00000110 8B08                    mov ecx,[rax]
   112 00000112 81F94E005400            cmp ecx,0x54004e
   113 00000118 751F                    jnz label0x72
   114                                  
   115 0000011A 81780444004C00          cmp dword [rax+0x4],0x4c0044
   116 00000121 7516                    jnz label0x72
   117                                  
   118 00000123 8178084C002E00          cmp dword [rax+0x8],0x2e004c
   119 0000012A 750D                    jnz label0x72
   120                                  
   121                                  label0x65:
   122 0000012C 4C8B5220                mov r10,[rdx+0x20]
   123 00000130 4D8990100A0000          mov [r8+0xa10],r10
   124 00000137 EB6D                    jmp label0xdf
   125                                  
   126                                  label0x72:
   127 00000139 4983B8180A000000        cmp qword [r8+0xa18],byte +0x0
   128 00000141 752C                    jnz label0xa8
   129                                  
   130 00000143 81F94B004500            cmp ecx,0x45004b
   131 00000149 7524                    jnz label0xa8
   132                                  
   133 0000014B 81780452004E00          cmp dword [rax+0x4],0x4e0052
   134 00000152 751B                    jnz label0xa8
   135                                  
   136 00000154 81780845004C00          cmp dword [rax+0x8],0x4c0045
   137 0000015B 7512                    jnz label0xa8
   138                                  
   139 0000015D 81780C33003200          cmp dword [rax+0xc],0x320033
   140 00000164 7509                    jnz label0xa8
   141                                  
   142 00000166 8178102E004400          cmp dword [rax+0x10],0x44002e
   143 0000016D 742C                    jz label0xd4
   144                                  
   145                                  label0xa8:
   146 0000016F 81F96B006500            cmp ecx,0x65006b
   147 00000175 752F                    jnz label0xdf
   148                                  
   149 00000177 81780472006E00          cmp dword [rax+0x4],0x6e0072
   150 0000017E 7526                    jnz label0xdf
   151                                  
   152 00000180 81780865006C00          cmp dword [rax+0x8],0x6c0065
   153 00000187 751D                    jnz label0xdf
   154                                  
   155 00000189 81780C33003200          cmp dword [rax+0xc],0x320033
   156 00000190 7514                    jnz label0xdf
   157                                  
   158 00000192 8178102E006400          cmp dword [rax+0x10],0x64002e
   159 00000199 750B                    jnz label0xdf
   160                                  
   161                                  label0xd4:
   162 0000019B 488B4220                mov rax,[rdx+0x20]
   163 0000019F 498980180A0000          mov [r8+0xa18],rax
   164                                  
   165                                  label0xdf:
   166 000001A6 488B12                  mov rdx,[rdx]
   167 000001A9 4C39CA                  cmp rdx,r9
   168 000001AC 0F853BFFFFFF            jnz label0x26
   169                                  
   170                                  label0xeb:
   171 000001B2 F3C3                    rep ret
   172                                  
   173                                  
   174 000001B4 CC                      int3
   175                                  
   176                                  
   177                                  GetProcAddress:
   178 000001B5 4883EC08                sub rsp,byte +0x8
   179 000001B9 B84D5A0000              mov eax,0x5a4d
   180 000001BE 4989CA                  mov r10,rcx
   181 000001C1 663901                  cmp [rcx],ax
   182 000001C4 0F8540020000            jnz label0x355
   183                                  
   184 000001CA 448B493C                mov r9d,[rcx+0x3c]
   185 000001CE 41813C0950450000        cmp dword [r9+rcx],0x4550
   186 000001D6 0F852E020000            jnz label0x355
   187                                  
   188 000001DC 450FB7440904            movzx r8d,word [r9+rcx+0x4]
   189 000001E2 41BB4C010000            mov r11d,0x14c
   190 000001E8 664539D8                cmp r8w,r11w
   191 000001EC 740F                    jz label0x148
   192                                  
   193 000001EE B864860000              mov eax,0x8664
   194 000001F3 664139C0                cmp r8w,ax
   195 000001F7 0F850D020000            jnz label0x355
   196                                  
   197                                  label0x148:
   198 000001FD 48895C2410              mov [rsp+0x10],rbx
   199 00000202 664539D8                cmp r8w,r11w
   200 00000206 4889742420              mov [rsp+0x20],rsi
   201 0000020B 48893C24                mov [rsp],rdi
   202 0000020F B870000000              mov eax,0x70
   203 00000214 B960000000              mov ecx,0x60
   204 00000219 0F44C1                  cmovz eax,ecx
   205 0000021C 4531DB                  xor r11d,r11d
   206 0000021F 4C01C8                  add rax,r9
   207 00000222 468B4C1018              mov r9d,[rax+r10+0x18]
   208 00000227 4D01D1                  add r9,r10
   209 0000022A 418B5920                mov ebx,[r9+0x20]
   210 0000022E 418B7924                mov edi,[r9+0x24]
   211 00000232 418B711C                mov esi,[r9+0x1c]
   212 00000236 4C01D3                  add rbx,r10
   213 00000239 4C01D7                  add rdi,r10
   214 0000023C 4C01D6                  add rsi,r10
   215 0000023F 45395918                cmp [r9+0x18],r11d
   216 00000243 0F86B3010000            jna label0x347
   217                                  
   218 00000249 48896C2418              mov [rsp+0x18],rbp
   219 0000024E 488BAA200A0000          mov rbp,[rdx+0xa20]
   220                                  
   221                                  label0x1a0:
   222 00000255 420FB70C5F              movzx ecx,word [rdi+r11*2]
   223 0000025A 428B049B                mov eax,[rbx+r11*4]
   224 0000025E 448B048E                mov r8d,[rsi+rcx*4]
   225 00000262 4C01D0                  add rax,r10
   226 00000265 4D01D0                  add r8,r10
   227 00000268 4885ED                  test rbp,rbp
   228 0000026B 752F                    jnz label0x1e7
   229                                  
   230 0000026D 81384C6F6164            cmp dword [rax],0x64616f4c
   231 00000273 7527                    jnz label0x1e7
   232                                  
   233 00000275 8178044C696272          cmp dword [rax+0x4],0x7262694c
   234 0000027C 751E                    jnz label0x1e7
   235                                  
   236 0000027E 81780861727957          cmp dword [rax+0x8],0x57797261
   237 00000285 7515                    jnz label0x1e7
   238                                  
   239 00000287 4038680C                cmp [rax+0xc],bpl
   240 0000028B 750F                    jnz label0x1e7
   241                                  
   242 0000028D 4C89C5                  mov rbp,r8
   243 00000290 4C8982200A0000          mov [rdx+0xa20],r8
   244 00000297 E94E010000              jmp label0x335
   245                                  
   246                                  label0x1e7:
   247 0000029C 4883BA280A000000        cmp qword [rdx+0xa28],byte +0x0
   248 000002A4 7526                    jnz label0x217
   249                                  
   250 000002A6 813846726565            cmp dword [rax],0x65657246
   251 000002AC 751E                    jnz label0x217
   252                                  
   253 000002AE 8178044C696272          cmp dword [rax+0x4],0x7262694c
   254 000002B5 7515                    jnz label0x217
   255                                  
   256 000002B7 81780861727900          cmp dword [rax+0x8],0x797261
   257 000002BE 750C                    jnz label0x217
   258                                  
   259 000002C0 4C8982280A0000          mov [rdx+0xa28],r8
   260 000002C7 E91E010000              jmp label0x335
   261                                  
   262                                  label0x217:
   263 000002CC 4883BA300A000000        cmp qword [rdx+0xa30],byte +0x0
   264 000002D4 7537                    jnz label0x258
   265                                  
   266 000002D6 813847657450            cmp dword [rax],0x50746547
   267 000002DC 752F                    jnz label0x258
   268                                  
   269 000002DE 817804726F6341          cmp dword [rax+0x4],0x41636f72
   270 000002E5 7526                    jnz label0x258
   271                                  
   272 000002E7 81780864647265          cmp dword [rax+0x8],0x65726464
   273 000002EE 751D                    jnz label0x258
   274                                  
   275 000002F0 8B480C                  mov ecx,[rax+0xc]
   276 000002F3 81E1FFFFFF00            and ecx,0xffffff
   277 000002F9 81F973730000            cmp ecx,0x7373
   278 000002FF 750C                    jnz label0x258
   279                                  
   280 00000301 4C8982300A0000          mov [rdx+0xa30],r8
   281 00000308 E9DD000000              jmp label0x335
   282                                  
   283                                  label0x258:
   284 0000030D 4883BA380A000000        cmp qword [rdx+0xa38],byte +0x0
   285 00000315 752C                    jnz label0x28e
   286                                  
   287 00000317 813843726561            cmp dword [rax],0x61657243
   288 0000031D 7524                    jnz label0x28e
   289                                  
   290 0000031F 81780474655468          cmp dword [rax+0x4],0x68546574
   291 00000326 751B                    jnz label0x28e
   292                                  
   293 00000328 81780872656164          cmp dword [rax+0x8],0x64616572
   294 0000032F 7512                    jnz label0x28e
   295                                  
   296 00000331 80780C00                cmp byte [rax+0xc],0x0
   297 00000335 750C                    jnz label0x28e
   298                                  
   299 00000337 4C8982380A0000          mov [rdx+0xa38],r8
   300 0000033E E9A7000000              jmp label0x335
   301                                  
   302                                  label0x28e:
   303 00000343 4883BA400A000000        cmp qword [rdx+0xa40],byte +0x0
   304 0000034B 7533                    jnz label0x2cb
   305                                  
   306 0000034D 813852746C45            cmp dword [rax],0x456c7452
   307 00000353 752B                    jnz label0x2cb
   308                                  
   309 00000355 81780478697455          cmp dword [rax+0x4],0x55746978
   310 0000035C 7522                    jnz label0x2cb
   311                                  
   312 0000035E 81780873657254          cmp dword [rax+0x8],0x54726573
   313 00000365 7519                    jnz label0x2cb
   314                                  
   315 00000367 81780C68726561          cmp dword [rax+0xc],0x61657268
   316 0000036E 7510                    jnz label0x2cb
   317                                  
   318 00000370 6683781064              cmp word [rax+0x10],byte +0x64
   319 00000375 7509                    jnz label0x2cb
   320                                  
   321 00000377 4C8982400A0000          mov [rdx+0xa40],r8
   322 0000037E EB6A                    jmp label0x335
   323                                  
   324                                  label0x2cb:
   325 00000380 4883BA480A000000        cmp qword [rdx+0xa48],byte +0x0
   326 00000388 7535                    jnz label0x30a
   327                                  
   328 0000038A 813857616974            cmp dword [rax],0x74696157
   329 00000390 752D                    jnz label0x30a
   330                                  
   331 00000392 817804466F7253          cmp dword [rax+0x4],0x53726f46
   332 00000399 7524                    jnz label0x30a
   333                                  
   334 0000039B 817808696E676C          cmp dword [rax+0x8],0x6c676e69
   335 000003A2 751B                    jnz label0x30a
   336                                  
   337 000003A4 81780C654F626A          cmp dword [rax+0xc],0x6a624f65
   338 000003AB 7512                    jnz label0x30a
   339                                  
   340 000003AD 81781065637400          cmp dword [rax+0x10],0x746365
   341 000003B4 7509                    jnz label0x30a
   342                                  
   343 000003B6 4C8982480A0000          mov [rdx+0xa48],r8
   344 000003BD EB2B                    jmp label0x335
   345                                  
   346                                  label0x30a:
   347 000003BF 4883BA500A000000        cmp qword [rdx+0xa50],byte +0x0
   348 000003C7 7521                    jnz label0x335
   349                                  
   350 000003C9 8138436C6F73            cmp dword [rax],0x736f6c43
   351 000003CF 7519                    jnz label0x335
   352                                  
   353 000003D1 8178046548616E          cmp dword [rax+0x4],0x6e614865
   354 000003D8 7510                    jnz label0x335
   355                                  
   356 000003DA 817808646C6500          cmp dword [rax+0x8],0x656c64
   357 000003E1 7507                    jnz label0x335
   358                                  
   359 000003E3 4C8982500A0000          mov [rdx+0xa50],r8
   360                                  
   361                                  label0x335:
   362 000003EA 41FFC3                  inc r11d
   363 000003ED 453B5918                cmp r11d,[r9+0x18]
   364 000003F1 0F825EFEFFFF            jc label0x1a0
   365                                  
   366 000003F7 488B6C2418              mov rbp,[rsp+0x18]
   367                                  
   368                                  label0x347:
   369 000003FC 488B742420              mov rsi,[rsp+0x20]
   370 00000401 488B5C2410              mov rbx,[rsp+0x10]
   371 00000406 488B3C24                mov rdi,[rsp]
   372                                  
   373                                  label0x355:
   374 0000040A 4883C408                add rsp,byte +0x8
   375 0000040E C3                      ret
   376                                  
   377                                  
   378 0000040F CC                      int3
   379 00000410 CC                      int3
